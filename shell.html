<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Atlas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        /* Reset default margins and ensure the canvas fills the entire viewport */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000; /* Optional: Set a background color */
        }

        /* Style the canvas to occupy full width and height */
        #canvas {
            display: block; /* Removes the small gap below the canvas */
            width: 100%;
            height: 100%;
        }

	#textinput {
	    position: absolute;
	    left: -10000px;
	}
    </style>
    <script>
        document.addEventListener('contextmenu', function(event) {
            event.preventDefault();
        });
    </script>
</head>
<body>
    <!-- Canvas where the Emscripten program will render -->
    <canvas id="canvas"></canvas>
    <!-- Hidden input for triggering keyboard -->
    <textarea id="textinput" autocapitalize="off" rows="1"></textarea>
    
    {{{ SCRIPT }}}

    <script>
        function showKeyboard() {
            // Focus the hidden input to trigger the virtual keyboard
            var input = document.getElementById('hidden-input');
            input.focus();

            // Optionally, clear the input's value to ensure clean key capture
            input.value = "";
        }
	canvas.addEventListener('touchstart', (event) => {
            event.preventDefault(); // Prevent default touch behavior
            showKeyboard(); // Show the keyboard
        });
        // Configure the Module object before the Emscripten script runs
        var Module = {
            canvas: (function() {
                var canvas = document.getElementById('canvas');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                return canvas;
            })(),
            

            // Adjust the canvas size when the window resizes
            onRuntimeInitialized: function() {
                window.addEventListener('resize', function() {
                    Module.canvas.width = window.innerWidth;
                    Module.canvas.height = window.innerHeight;
                    if (Module.resize) {
                        Module.resize(window.innerWidth, window.innerHeight);
                    }
                });

		const textinput_elem = document.getElementById('textinput')
Module.canvas = document.getElementById('canvas')

// Mobile input event handlers
Module.canvas.addEventListener('touchstart', ev => {
    textinput_elem.focus()
})
textinput_elem.addEventListener('input', ev => {
    const char = ev.data
    if (char) {
        const char_keycode = char.codePointAt(0)
        const upper_key = char.toUpperCase()
        const upper_keycode = upper_key.codePointAt(0)
        const down_up_options = {
            code: 'Key' + upper_key,
            key: char,
            keyCode: upper_keycode,
            which: upper_keycode,
        }
        window.dispatchEvent(new KeyboardEvent('keydown', down_up_options))
        window.dispatchEvent(new KeyboardEvent('keypress', {
            charCode: char_keycode,
            code: 'Key' + upper_key,
            key: char,
            keyCode: char_keycode,
            which: char_keycode,
        }))
        window.dispatchEvent(new KeyboardEvent('keyup', down_up_options))
    }

    // To fully reset we have to clear the value then blur and refocus, otherwise Android will keep trying to do its IME magic, which we don't want.
    textinput_elem.value = ''
    textinput_elem.blur()
    textinput_elem.focus()

    ev.preventDefault()
    ev.stopPropagation()
})
textinput_elem.addEventListener('keydown', ev => {
    if (ev.which === 8) {
        const options = {
            code: 'Backspace',
            key: 'Backspace',
            keyCode: 8,
            which: 8,
        }
        window.dispatchEvent(new KeyboardEvent('keydown', options))
        window.dispatchEvent(new KeyboardEvent('keyup', options))
        ev.preventDefault()
        ev.stopPropagation()
    }
    if (ev.which === 13) {
        const options = {
            charCode: 13,
            code: 'Enter',
            key: 'Enter',
            keyCode: 13,
            which: 13,
        }
        window.dispatchEvent(new KeyboardEvent('keydown', options))
        window.dispatchEvent(new KeyboardEvent('keypress', options))
        window.dispatchEvent(new KeyboardEvent('keyup', options))
        ev.preventDefault()
        ev.stopPropagation()
    }
    if (ev.which === 229) {
        ev.preventDefault()
        ev.stopPropagation()
    }
})
textinput_elem.addEventListener('keyup', ev => {
    if (ev.which === 8 || ev.which === 13 || ev.which === 229) {
        ev.preventDefault()
        ev.stopPropagation()
    }
})
				
            },

	    
            // Redirect print and printErr to the console
            print: (function() {
                return function(text) {
                    console.log(text);
                };
            })(),
            printErr: (function() {
                return function(text) {
                    console.error(text);
                };
            })()
        };
    </script>
</body>
</html>
